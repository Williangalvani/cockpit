import{c as Y,a8 as X,r as k,bw as te,w as U,o as ae,h as le,l as p,m as y,n as i,_ as Z,bx as oe,b9 as ne,s as n,K as se,J as re,a9 as ie,I as ue,L as de,k as N,ac as me,ad as ve,H as ce,v as fe,t as D,F as W,p as _,Q as I,G as c,N as x,V as pe,O as ye,P as Se,R as ge,ah as K,a4 as q,a5 as Q,W as be}from"./index-COCkkTru.js";const he={class:"canvas-container"},we=["width","height"],A=100,Ve=60,xe=Y({__name:"VideoPlayerStatsForNerds",props:{width:{type:Number,default:130},height:{type:Number,default:160},updateInterval:{type:Number,default:20},streamName:{type:String,default:""}},setup(C){const H=X(),r=C,$=k(null),u=k([]),w=k([]);let l=null,s=null,S=0,m=0,F=0,f=0,P=0,R=0,M=0,E=0,T=0,z=0,B=0,o=0,e=1e3,a=30,g=120;function G(b,t){return b/t*Ve}function J(){const t=$.value.getContext("2d"),{width:v,height:h}=r;t.clearRect(0,0,v,h),t.strokeStyle="rgb(255, 165, 0)",t.lineWidth=1,t.beginPath();for(let d=0;d<w.value.length;d++){const V=d/(A-1)*v,j=h-G(w.value[d],e);d===0?t.moveTo(V,j):t.lineTo(V,j)}t.stroke(),t.strokeStyle="rgb(0, 255, 0)",t.beginPath();for(let d=0;d<u.value.length;d++){const V=d/(A-1)*v,j=h-G(u.value[d],a);d===0?t.moveTo(V,j):t.lineTo(V,j)}t.stroke();const O=[{label:"Stream",value:r.streamName,color:"white"},{label:"Size",value:o?`${o}p`:"N/A",color:"white"},{label:"Packets Lost",value:`${m} (${z.toFixed(0)}%)`,color:"white"},{label:"Framedrops",value:T,color:"white"},{label:"Jitter(ms)",value:f.toFixed(0),color:"white"},{label:"Freezes",value:`${M}(${E.toFixed(1)}s)`,color:"white"},{label:"Bitrate",value:`${S.toFixed(0)}kbps`,color:"rgb(255, 165, 0)"},{label:"FPS",value:B.toFixed(2),color:"rgb(0, 255, 0)"}];t.font="10px Arial",O.forEach((d,V)=>{t.fillStyle=d.color,t.fillText(`${d.label}: ${d.value}`,5,12+V*12)}),l=requestAnimationFrame(J)}const L=new te({getStatsInterval:100});function ee(){u.value.push(B),w.value.push(S),u.value.length>A&&u.value.shift(),w.value.length>A&&w.value.shift(),e=Math.max(e,...w.value),a=Math.max(a,...u.value),a>g&&(a=g)}return U(H.activeStreams,b=>{Object.keys(b).forEach(t=>{var h;if(t!==r.streamName)return;const v=(h=b[t])==null?void 0:h.webRtcManager.session;!v||!v.peerConnection||L.peersToMonitor[v.consumerId]||L.addConnection({pc:v.peerConnection,peerId:v.consumerId,connectionId:v.id,remote:!1})})}),ae(()=>{s=setInterval(ee,r.updateInterval),J(),L.on("stats",b=>{try{const t=b.data.video.inbound[0];if(t===void 0)return;if(t.bitrate){const v=t.bitrate/1e3;S=S*.8+v*.2;let h=t.jitterBufferDelay-P,O=t.jitterBufferEmittedCount-R;f=1e3*h/O,P=t.jitterBufferDelay,R=t.jitterBufferEmittedCount,m=t.packetsLost,F=t.packetsReceived,z=m/(m+F)*100,M=t.freezeCount,E=t.totalFreezesDuration,T=t.framesDropped,B=t.framesPerSecond??0,o=t.frameHeight}}catch(t){console.error(t)}})}),le(()=>{clearInterval(s),cancelAnimationFrame(l)}),(b,t)=>(p(),y("div",he,[i("canvas",{ref_key:"canvasRef",ref:$,width:C.width,height:C.height},null,8,we)]))}}),ke=Z(xe,[["__scopeId","data-v-cddb0399"]]),Fe=oe("v-banner-text"),Ne={ref:"videoWidget",class:"video-widget"},Ie={key:1,class:"no-video-alert"},Ce={key:2,class:"no-video-alert"},$e={key:3,class:"no-video-alert"},Re={class:"no-video-alert"},Be={key:4,class:"no-video-alert"},je={class:"flex-wrap justify-center d-flex ga-5"},De=Y({__name:"VideoPlayer",props:{widget:{}},setup(C){ne(o=>({"281c6376":n(l).options.videoFitStyle,"20fb88cc":T.value}));const H=se(),r=X(),$=re(),{namessAvailableAbstractedStreams:u}=ie(r),l=ue(C).widget,s=k(),S=k(),m=k(),F=k(!1);de(()=>{const o={videoFitStyle:"cover",flipHorizontally:!1,flipVertically:!1,rotationAngle:0,statsForNerds:!1,internalStreamName:void 0};l.value.options=Object.assign({},o,l.value.options),s.value=l.value.options.internalStreamName});const f=N(()=>s.value?r.externalStreamId(s.value):void 0);U(()=>r.streamsCorrespondency,()=>{if(m.value=void 0,!s.value)return;const o=r.externalStreamId(s.value);if(!o)return;const e=r.streamsCorrespondency.find(g=>g.externalId===o);if(!e)return;const a=e.name;s.value!==a&&(s.value=a,l.value.options.internalStreamName=a)},{deep:!0});const P=setInterval(()=>{var o;if(l.value.options.internalStreamName===void 0&&!u.value.isEmpty()&&(l.value.options.internalStreamName=u.value[0],s.value=l.value.options.internalStreamName),f.value!==void 0){const e=r.getMediaStream(f.value);me(e,m.value)||(m.value=e);const a=((o=r.getStreamData(f.value))==null?void 0:o.connected)??!1;a!==F.value&&(F.value=a)}if(!u.value.isEmpty()&&!u.value.includes(s.value)){if(r.lastRenamedStreamName!==""){s.value=r.lastRenamedStreamName;return}s.value=u.value[0]}},1e3);ve(()=>clearInterval(P)),U(s,()=>{l.value.options.internalStreamName=s.value,m.value=void 0}),U(m,()=>{!S.value||!m.value||(S.value.srcObject=m.value,S.value.play().then(()=>console.log("[VideoPlayer] Stream is playing")).catch(o=>{const e=`Failed to play stream. Reason: ${o}`;console.error(`[VideoPlayer] ${e}`)}))});const R=o=>{l.value.options.rotationAngle+=o},M=N(()=>`scale(${l.value.options.flipHorizontally?-1:1}, ${l.value.options.flipVertically?-1:1})`),E=N(()=>`rotate(${l.value.options.rotationAngle??0}deg)`),T=N(()=>`${M.value} ${E.value}`),z=N(()=>{var o;return f.value===void 0?"Unknown.":((o=r.getStreamData(f.value))==null?void 0:o.webRtcManager.signallerStatus)??"Unknown."}),B=N(()=>{var e;if(f.value===void 0)return"Unknown.";const o=r.availableIceIps;return!o.isEmpty()&&!o.find(a=>r.allowedIceIps.includes(a))?`Stream is coming from IPs [${o.join(", ")}], which are not in the list of allowed sources
      [${r.allowedIceIps.join(", ")}].\\n Please check your configuration.`:((e=r.getStreamData(f.value))==null?void 0:e.webRtcManager.streamStatus)??"Unknown."});return(o,e)=>(p(),y(W,null,[i("div",Ne,[n(l).options.statsForNerds?(p(),ce(ke,{key:0,"stream-name":f.value},null,8,["stream-name"])):fe("",!0),s.value===void 0?(p(),y("div",Ie,e[8]||(e[8]=[i("span",null,"No video stream selected.",-1)]))):!n(u).isEmpty()&&!n(u).includes(s.value)?(p(),y("div",Ce,[i("p",null,'The selected stream "'+D(s.value)+'" is not available.',1),i("p",null,"Available ones are: "+D(n(u).map(a=>`"${a}"`).join(", "))+".",1),e[9]||(e[9]=i("br",null,null,-1)),e[10]||(e[10]=i("p",null," This can happen if you changed vehicles and the stream name in the new one is different from the former, or if the source is not available at all. ",-1)),e[11]||(e[11]=i("br",null,null,-1)),e[12]||(e[12]=i("p",null," Please open this video player configuration and select a new stream from the ones available, or check your source for issues. ",-1))])):F.value?(p(),y("div",Be,e[17]||(e[17]=[i("p",null,"Loading stream...",-1)]))):(p(),y("div",$e,[i("div",Re,[i("p",null,[e[14]||(e[14]=i("span",{class:"text-xl font-bold"},"Server status: ",-1)),(p(!0),y(W,null,_(z.value.toString().split("\\n"),(a,g)=>(p(),y("span",{key:g},[I(D(a)+" ",1),e[13]||(e[13]=i("br",null,null,-1))]))),128))]),i("p",null,[e[16]||(e[16]=i("span",{class:"text-xl font-bold"},"Stream status: ",-1)),(p(!0),y(W,null,_(B.value.toString().split("\\n"),(a,g)=>(p(),y("span",{key:g},[I(D(a)+" ",1),e[15]||(e[15]=i("br",null,null,-1))]))),128))])])])),i("video",{id:"mainDisplayStream",ref_key:"videoElement",ref:S,muted:"",autoplay:"",playsinline:"",disablePictureInPicture:""}," Your browser does not support the video tag. ",512)],512),c(be,{modelValue:n($).widgetManagerVars(n(l).hash).configMenuOpen,"onUpdate:modelValue":e[7]||(e[7]=a=>n($).widgetManagerVars(n(l).hash).configMenuOpen=a),width:"auto"},{default:x(()=>[c(pe,{class:"pa-4 text-white",style:ye([{"border-radius":"15px"},n(H).globalGlassMenuStyles])},{default:x(()=>[c(Se,{class:"text-center"},{default:x(()=>e[18]||(e[18]=[I("Video widget config")])),_:1}),c(ge,{class:"flex flex-col gap-y-4"},{default:x(()=>[c(K,{modelValue:s.value,"onUpdate:modelValue":e[0]||(e[0]=a=>s.value=a),label:"Stream name",class:"my-3",items:n(u),"item-title":"name",density:"compact",variant:"outlined","no-data-text":"No streams available.","hide-details":"","return-object":""},null,8,["modelValue","items"]),c(K,{modelValue:n(l).options.videoFitStyle,"onUpdate:modelValue":e[1]||(e[1]=a=>n(l).options.videoFitStyle=a),label:"Fit style",class:"my-3",items:["cover","fill","contain"],"item-title":"style",density:"compact",variant:"outlined","no-data-text":"No streams available.","hide-details":"","return-object":""},null,8,["modelValue"]),c(Fe,null,{default:x(()=>[I('Saved stream name: "'+D(n(l).options.internalStreamName)+'"',1)]),_:1}),c(q,{modelValue:n(l).options.flipHorizontally,"onUpdate:modelValue":e[2]||(e[2]=a=>n(l).options.flipHorizontally=a),class:"my-1",label:"Flip horizontally",color:n(l).options.flipHorizontally?"white":void 0,"hide-details":""},null,8,["modelValue","color"]),c(q,{modelValue:n(l).options.flipVertically,"onUpdate:modelValue":e[3]||(e[3]=a=>n(l).options.flipVertically=a),class:"my-1",label:"Flip vertically",color:n(l).options.flipVertically?"white":void 0,"hide-details":""},null,8,["modelValue","color"]),c(q,{modelValue:n(l).options.statsForNerds,"onUpdate:modelValue":e[4]||(e[4]=a=>n(l).options.statsForNerds=a),class:"my-1",label:"Stats for nerds",color:n(l).options.statsForNerds?"white":void 0,"hide-details":""},null,8,["modelValue","color"]),i("div",je,[c(Q,{"prepend-icon":"mdi-file-rotate-left",variant:"outlined",onClick:e[5]||(e[5]=a=>R(-90))},{default:x(()=>e[19]||(e[19]=[I(" Rotate Left")])),_:1}),c(Q,{"prepend-icon":"mdi-file-rotate-right",variant:"outlined",onClick:e[6]||(e[6]=a=>R(90))},{default:x(()=>e[20]||(e[20]=[I(" Rotate Right")])),_:1})])]),_:1})]),_:1},8,["style"])]),_:1},8,["modelValue"])],64))}}),Me=Z(De,[["__scopeId","data-v-f57695a6"]]);export{Me as default};
