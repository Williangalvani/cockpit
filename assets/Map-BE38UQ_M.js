import{bf as Te,bg as He,bh as Ae,bi as G,f as Ne,bj as he,bk as Oe,bl as ze,c as $e,b9 as Fe,I as Pe,K as Ue,a7 as Be,u as _e,aj as Re,r as v,k as N,M as be,Y as ye,L as Xe,bm as u,j as We,w as g,o as Ye,bn as h,ad as Ge,bo as qe,aw as Ze,bp as je,bq as Me,at as Ke,J as Je,l as E,m as ne,n as q,D as we,T as xe,H as P,v as se,q as r,aq as D,a5 as Z,s as L,O as j,G as U,N as K,V as Qe,P as ea,Q as aa,R as oa,a4 as ta,W as la,br as na,F as sa,y as ra,z as ia,E as ua,bs as re}from"./index-DaD2NU7R.js";function Ce(m,b){if(m==null)throw new TypeError("assign requires that input parameter not be null or undefined");for(var l in b)Object.prototype.hasOwnProperty.call(b,l)&&(m[l]=b[l]);return m}function ca(m){return Ce({},m)}var ke=1440,da=2520,ie=43200,va=86400;function ma(m,b,l){var O,z;Te(2,arguments);var i=ze(),n=(O=(z=l==null?void 0:l.locale)!==null&&z!==void 0?z:i.locale)!==null&&O!==void 0?O:He;if(!n.formatDistance)throw new RangeError("locale must contain formatDistance property");var o=Ae(m,b);if(isNaN(o))throw new RangeError("Invalid time value");var s=Ce(ca(l),{addSuffix:!!(l!=null&&l.addSuffix),comparison:o}),y,d;o>0?(y=G(b),d=G(m)):(y=G(m),d=G(b));var k=Ne(d,y),T=(he(d)-he(y))/1e3,c=Math.round((k-T)/60),C;if(c<2)return l!=null&&l.includeSeconds?k<5?n.formatDistance("lessThanXSeconds",5,s):k<10?n.formatDistance("lessThanXSeconds",10,s):k<20?n.formatDistance("lessThanXSeconds",20,s):k<40?n.formatDistance("halfAMinute",0,s):k<60?n.formatDistance("lessThanXMinutes",1,s):n.formatDistance("xMinutes",1,s):c===0?n.formatDistance("lessThanXMinutes",1,s):n.formatDistance("xMinutes",c,s);if(c<45)return n.formatDistance("xMinutes",c,s);if(c<90)return n.formatDistance("aboutXHours",1,s);if(c<ke){var B=Math.round(c/60);return n.formatDistance("aboutXHours",B,s)}else{if(c<da)return n.formatDistance("xDays",1,s);if(c<ie){var J=Math.round(c/ke);return n.formatDistance("xDays",J,s)}else if(c<va)return C=Math.round(c/ie),n.formatDistance("aboutXMonths",C,s)}if(C=Oe(d,y),C<12){var _=Math.round(c/ie);return n.formatDistance("xMonths",_,s)}else{var $=C%12,H=Math.floor(C/12);return $<3?n.formatDistance("aboutXYears",H,s):$<9?n.formatDistance("overXYears",H,s):n.formatDistance("almostXYears",H+1,s)}}function fa(m,b){return Te(1,arguments),ma(m,Date.now(),b)}const pa=""+new URL("blueboat-marker-DyHmCFOq.png",import.meta.url).href,ga=""+new URL("brov2-marker-CBzp11FX.png",import.meta.url).href,ha=""+new URL("generic-vehicle-marker-SovxT5Tc.png",import.meta.url).href,ba=["id"],Ma=$e({__name:"Map",props:{widget:{}},setup(m){var ge;Fe(e=>({"416f5bb6":De.value}));const b=m,l=Pe(b).widget,O=Ue(),{showDialog:z}=Be(),i=_e(),n=Re(),o=v(),s=v(15),y=v([-27.5935,-48.55854]),d=v(),k=N(()=>`map-${l.value.hash}`),T=v(!1);be.registerUsage(ye.latitude),be.registerUsage(ye.longitude),Xe(()=>{Object.keys(l.value.options).length===0&&(l.value.options={showVehiclePath:!0}),f.enableAutoUpdate()});const c=u.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"© OpenStreetMap"}),C=u.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:19,attribution:"© Esri World Imagery"}),B=u.tileLayer("http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}",{maxZoom:23,subdomains:["mt0","mt1","mt2","mt3"],maxNativeZoom:22,attribution:"© Google Maps"}),J={OpenStreetMap:c,"Esri World Imagery":C,"Google Maps":B},_=v(),$=We(_),H=u.control.zoom({position:"bottomright"}),ue=u.control.layers(J);g(T,()=>{o.value!==void 0&&(T.value?(o.value.addControl(H),o.value.addControl(ue)):(o.value.removeControl(H),o.value.removeControl(ue)))}),g($,()=>{T.value=$.value}),Ye(async()=>{o.value=u.map(k.value,{layers:[B,c,C],attributionControl:!1}).setView(y.value,s.value),o.value.removeControl(o.value.zoomControl),o.value.on("moveend",()=>{if(o.value===void 0)return;let{lat:e,lng:a}=o.value.getCenter();e&&a&&(y.value=[e,a])}),o.value.on("zoomend",()=>{var e;o.value!==void 0&&(s.value=((e=o.value)==null?void 0:e.getZoom())??y.value)}),o.value.on("click",()=>{o.value!==void 0&&o.value.on("click",ve)}),o.value.on("contextmenu",()=>{me()}),f.enableAutoUpdate(),window.addEventListener("keydown",fe),p.value?f.goToTarget(h.VEHICLE):f.goToTarget(h.HOME)}),Ge(()=>{f.disableAutoUpdate(),window.removeEventListener("keydown",fe),o.value&&(o.value.off("click",ve),o.value.off("contextmenu"))}),g(y,(e,a)=>{var t,M,x;e.toString()!==a.toString()&&((t=o.value)==null||t.panTo(e),(x=(M=V.value)==null?void 0:M.getTooltip())==null||x.setContent(`Home: ${e[0].toFixed(6)}, ${e[1].toFixed(6)}`))}),g(o,(e,a)=>{o.value!==void 0&&(e==null?void 0:e.options)===void 0&&(o.value=a)}),g(s,(e,a)=>{var t;e!==a&&((t=o.value)==null||t.setZoom(s.value))}),g(b.widget,()=>{var e;(e=o.value)==null||e.invalidateSize()});const R=v(void 0),f=new qe(e=>R.value=e,e=>y.value=e);f.setTrackableTarget(h.VEHICLE,()=>p.value),f.setTrackableTarget(h.HOME,()=>d.value);const p=N(()=>i.coordinates.latitude?[i.coordinates.latitude,i.coordinates.longitude]:void 0),Q=N(()=>{var e;return i.attitude.yaw?Ze((e=i.attitude)==null?void 0:e.yaw):0}),ce=N(()=>{const e=i.lastHeartbeat;return e?`${fa(e??0,{includeSeconds:!0})} ago`:"never"}),{history:Ie}=je(p);(ge=navigator==null?void 0:navigator.geolocation)==null||ge.watchPosition(e=>d.value=[e.coords.latitude,e.coords.longitude],e=>console.error(`Failed to get position: (${e.code}) ${e.message}`),{enableHighAccuracy:!1,timeout:5e3,maximumAge:0});let de=!0;g([d,o],async()=>{d.value===y.value||!o.value||!de||(f.goToTarget(h.HOME),de=!1)});const I=v();g(i.coordinates,()=>{if(!(!o.value||!p.value)){if(I.value===void 0){let e=ha;i.vehicleType===Me.MAV_TYPE_SURFACE_BOAT?e=pa:i.vehicleType===Me.MAV_TYPE_SUBMARINE&&(e=ga);const a=u.divIcon({className:"vehicle-marker",html:`<img src="${e}" style="width: 64px; height: 64px;">`,iconSize:[64,64],iconAnchor:[32,32]});I.value=u.marker(p.value,{icon:a});const t=u.tooltip({content:"No data available",className:"waypoint-tooltip",offset:[40,0]});I.value.bindTooltip(t),o.value.addLayer(I.value)}I.value.setLatLng(p.value)}}),g(p,(e,a)=>{R.value===h.VEHICLE||a!==void 0||f.follow(h.VEHICLE)}),g([p,Q,ce,()=>i.isArmed],()=>{var a,t,M,x,w;if(I.value===void 0)return;(x=I.value.getTooltip())==null||x.setContent(`
    <p>Coordinates: ${(a=p.value)==null?void 0:a[0].toFixed(6)}, ${(t=p.value)==null?void 0:t[1].toFixed(6)}</p>
    <p>Velocity: ${((M=i.velocity.ground)==null?void 0:M.toFixed(2))??"N/A"} m/s</p>
    <p>Heading: ${Q.value.toFixed(2)}°</p>
    <p>${i.isArmed?"Armed":"Disarmed"}</p>
    <p>Last seen: ${ce.value}</p>
  `);const e=(w=I.value.getElement())==null?void 0:w.querySelector("img");e&&(e.style.transform=`rotate(${Q.value}deg)`)});const V=v();g(d,()=>{if(o.value===void 0)return;const e=d.value;if(e!==void 0){if(V.value===void 0){V.value=u.marker(e);const a=u.divIcon({className:"marker-icon",iconSize:[32,32],iconAnchor:[16,16],html:"H"});V.value.setIcon(a);const t=u.tooltip({content:"No data available",className:"waypoint-tooltip"});V.value.bindTooltip(t),o.value.addLayer(V.value)}V.value.setLatLng(d.value)}});const ee=v();g(n.currentPlanningWaypoints,e=>{if(o.value!==void 0){if(ee.value===void 0){const a=e.map(t=>t.coordinates);ee.value=u.polyline(a,{color:"#358AC3"}).addTo(o.value)}ee.value.setLatLngs(e.map(a=>a.coordinates)),e.forEach((a,t)=>{var w;const M=u.marker(a.coordinates),x=u.divIcon({className:"marker-icon",iconSize:[32,32],iconAnchor:[16,16],html:`${t}`});M.setIcon(x),(w=o.value)==null||w.addLayer(M)})}});const ae=v();g(Ie,e=>{if(o.value===void 0||e===void 0)return;ae.value===void 0&&(ae.value=u.polyline([],{color:"#ffff00"}).addTo(o.value));const a=e.filter(t=>t.snapshot!==void 0).map(t=>t.snapshot);ae.value.setLatLngs(a)});const X=v(!1),A=v(null),W=Ke({top:"0px",left:"0px"}),S=v(),ve=e=>{var a,t,M,x;if(S.value!==void 0&&o.value!==void 0&&((a=S.value)==null||a.removeFrom(o.value)),((t=e==null?void 0:e.latlng)==null?void 0:t.lat)!=null&&((M=e==null?void 0:e.latlng)==null?void 0:M.lng)!=null){A.value=[e.latlng.lat,e.latlng.lng],X.value=!0;const w=(x=o.value)==null?void 0:x.getContainer();if(w){const{x:te,y:le}=w.getBoundingClientRect();W.left=`${e.originalEvent.clientX-te}px`,W.top=`${e.originalEvent.clientY-le}px`}}else console.error("Invalid event structure:",e);if(o.value!==void 0){S.value=u.marker(A.value);const w=u.divIcon({className:"marker-icon",iconSize:[32,32],iconAnchor:[16,16]});S.value.setIcon(w),o.value.addLayer(S.value)}},Ee=e=>{switch(e){case"goto":if(A.value){const w=i.coordinates.altitude??0,te=A.value[0],le=A.value[1];ra(async()=>{try{await i.goTo(0,0,0,0,te,le,w)}catch(Le){re({message:Le,variant:"error"})}},{command:"GoTo"},ia(ua.GOTO))}break;default:console.warn("Unknown menu option selected:",e)}X.value=!1},me=()=>{X.value=!1,A.value=null,o.value!==void 0&&S.value!==void 0&&o.value.removeLayer(S.value)},fe=e=>{e.key==="Escape"&&me()},Y=v(!1),oe=v(0),Ve=async()=>{for(Y.value=!0,oe.value=0;n.currentPlanningWaypoints.length>0;)n.currentPlanningWaypoints.pop();const e=async a=>{oe.value=a};try{(await i.fetchMission(e)).forEach(t=>{n.currentPlanningWaypoints.push(t)}),re({variant:"success",message:"Mission download succeed!",duration:3e3})}catch(a){z({variant:"error",title:"Mission download failed",message:a,timer:5e3})}finally{Y.value=!1}},Se=async()=>{try{await i.startMission()}catch{re({message:"Failed to start mission.",variant:"error"})}},F=Je(),De=N(()=>`${Math.max(-F.widgetClearanceForVisibleArea(l.value).bottom,0)}px`),pe=N(()=>`${Math.max(-F.widgetClearanceForVisibleArea(l.value).top,0)}px`);return(e,a)=>(E(),ne(sa,null,[q("div",{ref_key:"mapBase",ref:_,class:se(["page-base",r(F).editingMode?"pointer-events-none":"pointer-events-auto"])},[q("div",{id:k.value,ref_key:"map",ref:o,class:"map"},[T.value?we((E(),P(Z,{key:0,class:se(["absolute left-0 m-3 bottom-button bg-slate-50",d.value?"":"active-events-on-disabled"]),color:R.value==r(h).HOME?"red":"",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-home-map-marker",size:"x-small",disabled:!d.value,onClick:a[0]||(a[0]=D(t=>r(f).goToTarget(r(h).HOME,!0),["stop"])),onDblclick:a[1]||(a[1]=D(t=>r(f).follow(r(h).HOME),["stop"]))},null,8,["class","color","disabled"])),[[xe,d.value?"Center map on home position.":"Home position is currently undefined."]]):L("",!0),T.value?we((E(),P(Z,{key:1,class:se(["absolute m-3 bottom-button left-10 bg-slate-50",p.value?"":"active-events-on-disabled"]),color:R.value==r(h).VEHICLE?"red":"",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-airplane-marker",size:"x-small",disabled:!p.value,onClick:a[2]||(a[2]=D(t=>r(f).goToTarget(r(h).VEHICLE,!0),["stop"])),onDblclick:a[3]||(a[3]=D(t=>r(f).follow(r(h).VEHICLE),["stop"]))},null,8,["class","color","disabled"])),[[xe,p.value?"Center map on vehicle position.":"Vehicle position is currently undefined."]]):L("",!0),T.value?(E(),P(Z,{key:2,class:"absolute m-3 bottom-button left-20 bg-slate-50",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-download",size:"x-small",onClick:D(Ve,["stop"])})):L("",!0),T.value?(E(),P(Z,{key:3,class:"absolute mb-3 ml-1 bottom-button left-32 bg-slate-50",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-play",size:"x-small",onClick:D(Se,["stop"])})):L("",!0)],8,ba)],2),X.value?(E(),ne("div",{key:0,class:"context-menu",style:j({top:W.top,left:W.left})},[q("ul",{onClick:a[5]||(a[5]=D(()=>{},["stop"]))},[q("li",{onClick:a[4]||(a[4]=t=>Ee("goto"))},"GoTo")])],4)):L("",!0),U(la,{modelValue:r(F).widgetManagerVars(r(l).hash).configMenuOpen,"onUpdate:modelValue":a[7]||(a[7]=t=>r(F).widgetManagerVars(r(l).hash).configMenuOpen=t),width:"auto"},{default:K(()=>[U(Qe,{class:"pa-2",style:j(r(O).globalGlassMenuStyles)},{default:K(()=>[U(ea,{class:"text-center"},{default:K(()=>a[8]||(a[8]=[aa("Map widget settings")])),_:1}),U(oa,null,{default:K(()=>[U(ta,{modelValue:r(l).options.showVehiclePath,"onUpdate:modelValue":a[6]||(a[6]=t=>r(l).options.showVehiclePath=t),class:"my-1",label:"Show vehicle path",color:r(l).options.showVehiclePath?"white":void 0,"hide-details":""},null,8,["modelValue","color"])]),_:1})]),_:1},8,["style"])]),_:1},8,["modelValue"]),Y.value?(E(),P(na,{key:1,"model-value":oe.value,height:"10",absolute:"",bottom:"",color:"white",style:j(`top: ${pe.value}`)},null,8,["model-value","style"])):L("",!0),Y.value?(E(),ne("p",{key:2,style:j({top:pe.value}),class:"absolute left-[7px] mt-4 flex text-md font-bold text-white z-30 drop-shadow-md"}," Loading mission... ",4)):L("",!0)],64))}});export{Ma as default};
